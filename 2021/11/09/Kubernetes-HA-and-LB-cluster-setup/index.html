<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />

    

    
    <title>Kubernetes - HA and LB cluster setup | 演好自己的戏，走好自己的路</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="Kubernetes" />
    
    <meta name="description" content="分布式系统的HA和LB一直是一个关键性技术点，Kubernetes也有许多方面的考虑和实现来支持HA/LB，比方说lease，网络流量方面的LB（kube-proxy），以及在整体架构上与业界比较通用的haproxy与keepalived解决方案的集成，其它第三方的项目包括kube-vip, nginx-ingress等。 本文记录一下在与haproxy以及keepalived做集成的一些关键性的">
<meta name="keywords" content="Kubernetes">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes - HA and LB cluster setup">
<meta property="og:url" content="http://jungler.com/2021/11/09/Kubernetes-HA-and-LB-cluster-setup/index.html">
<meta property="og:site_name" content="演好自己的戏，走好自己的路">
<meta property="og:description" content="分布式系统的HA和LB一直是一个关键性技术点，Kubernetes也有许多方面的考虑和实现来支持HA/LB，比方说lease，网络流量方面的LB（kube-proxy），以及在整体架构上与业界比较通用的haproxy与keepalived解决方案的集成，其它第三方的项目包括kube-vip, nginx-ingress等。 本文记录一下在与haproxy以及keepalived做集成的一些关键性的">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://jungler.com/css/images/mid-autumn.jpg">
<meta property="og:updated_time" content="2022-06-19T11:49:19.353Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kubernetes - HA and LB cluster setup">
<meta name="twitter:description" content="分布式系统的HA和LB一直是一个关键性技术点，Kubernetes也有许多方面的考虑和实现来支持HA/LB，比方说lease，网络流量方面的LB（kube-proxy），以及在整体架构上与业界比较通用的haproxy与keepalived解决方案的集成，其它第三方的项目包括kube-vip, nginx-ingress等。 本文记录一下在与haproxy以及keepalived做集成的一些关键性的">
<meta name="twitter:image" content="http://jungler.com/css/images/mid-autumn.jpg">
    

    
        <link rel="alternate" href="/" title="演好自己的戏，走好自己的路" type="application/atom+xml" />
    

    
        <link rel="icon" href="/css/images/favicon.png" />
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/3.4.1/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css">
    
    
    


</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">花生人的苟且人生</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                        
                                    
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/about/index.html">关于</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    未分类
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-Kubernetes-HA-and-LB-cluster-setup" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        Kubernetes - HA and LB cluster setup
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
      <i class="fa fa-calendar"></i>
      <a href="/2021/11/09/Kubernetes-HA-and-LB-cluster-setup/" class="article-date">
         <time datetime="2021-11-09T03:07:45.000Z" itemprop="datePublished">2021-11-09</time>
      </a>
    </div>


                

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Kubernetes/">Kubernetes</a>
    </div>

                

                

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p>分布式系统的HA和LB一直是一个关键性技术点，Kubernetes也有许多方面的考虑和实现来支持HA/LB，比方说lease，网络流量方面的LB（kube-proxy），以及在整体架构上与业界比较通用的haproxy与keepalived解决方案的集成，其它第三方的项目包括kube-vip, nginx-ingress等。</p>
<p>本文记录一下在与haproxy以及keepalived做集成的一些关键性的问题和配置。一个最简单的实验需要至少3个控制节点外加一个计算节点。</p>
<p>考虑HA/LB主要考虑的是控制面上的一些服务，例如kube-apiserver，etcd，kube-scheduler以及kube-controller-manager。</p>
<ul>
<li>kube-apiserver是整个cluster的入口，各种状态查询，pod的CRUD都需要通过apiserver来接入，所以需要重点考虑，在我们的实验中我们引入haproxy对apiserver做负载均衡，在引入keepalived对haproxy做HA。</li>
<li>kube-scheduler 与kube-controller-manager相对于apiserver来说压力较小，例如scheduler只需要对pod的创建做出响应，所以直接采用lease机制即可。</li>
<li>etcd支持创建一个etcd的cluster，可以直接调用etcd的CLI添加一些新的member。etcd可以是和控制节点集成在一起（stacked etcd cluster）也可以独立在其它的节点上(external etcd cluster)，参考官方文档 - <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/ha-topology/" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/ha-topology/</a></li>
</ul>
<p><img src="https://github.com/chendave/chendave.github.io/raw/master/css/images/kubeadm-ha-topology-stacked-etcd.svg" alt="ha-topology-stacked-etcd"></p>
<p><img src="https://github.com/chendave/chendave.github.io/raw/master/css/images/kubeadm-ha-topology-external-etcd.svg" alt="ha-topology-external-etcd"></p>
<h2 id="lease机制"><a href="#lease机制" class="headerlink" title="lease机制"></a>lease机制</h2><p>首先来看看lease机制，或者说是leader-election机制，<a href="https://github.com/kubernetes/client-go/blob/master/examples/leader-election/main.go" target="_blank" rel="noopener">client-go例子</a>.<br>其本质是在竞争创建一个LeaseLock的object, 服务可以在多台机器上同时启动，但最终只有一个服务能成功抢占并创建这个lease对象。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/kubernetes/client-go/blob/9b0b23a8ade2b5323d6624146cea2ad7b8928f25/tools/leaderelection/leaderelection.go#L327-L341</span></span><br><span class="line"></span><br><span class="line">oldLeaderElectionRecord, oldLeaderElectionRawRecord, err := le.config.Lock.Get(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> !errors.IsNotFound(err) &#123;</span><br><span class="line">			klog.Errorf(<span class="string">"error retrieving resource lock %v: %v"</span>, le.config.Lock.Describe(), err)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err = le.config.Lock.Create(ctx, leaderElectionRecord); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			klog.Errorf(<span class="string">"error initially creating leader election record: %v"</span>, err)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		le.setObservedRecord(&amp;leaderElectionRecord)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>再来看看scheduler的相关代码，</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// go/src/k8s.io/kubernetes/cmd/kube-scheduler/app/server.go</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> cc.LeaderElection != <span class="literal">nil</span> &#123;</span><br><span class="line">		cc.LeaderElection.Callbacks = leaderelection.LeaderCallbacks&#123;</span><br><span class="line">			OnStartedLeading: <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">				<span class="built_in">close</span>(waitingForLeader)</span><br><span class="line">				sched.Run(ctx)</span><br><span class="line">			&#125;,</span><br><span class="line">			OnStoppedLeading: <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">				<span class="keyword">select</span> &#123;</span><br><span class="line">				<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">					<span class="comment">// We were asked to terminate. Exit 0.</span></span><br><span class="line">					klog.InfoS(<span class="string">"Requested to terminate, exiting"</span>)</span><br><span class="line">					os.Exit(<span class="number">0</span>)</span><br><span class="line">				<span class="keyword">default</span>:</span><br><span class="line">					<span class="comment">// We lost the lock.</span></span><br><span class="line">					klog.Exitf(<span class="string">"leaderelection lost"</span>)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;</span><br><span class="line">		leaderElector, err := leaderelection.NewLeaderElector(*cc.LeaderElection)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"couldn't create leader elector: %v"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		leaderElector.Run(ctx)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"lost lease"</span>)</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>而<code>leaderElector.Run(ctx)</code>最后也是一样调用<code>le.acquire(ctx)</code>来尝试创建lease对象。</p>
<p>在多个scheduler或者controller manager的情况下，如何判断那个节点的服务是生效的？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl get lease -A</span><br><span class="line"></span><br><span class="line">NAMESPACE          NAME                     HOLDER                                         AGE</span><br><span class="line">kube-node-lease   master1                   master1                                        13d</span><br><span class="line">kube-node-lease   master2                   master2                                        13d</span><br><span class="line">kube-node-lease   master3                   master3                                        13d</span><br><span class="line">kube-system       kube-controller-manager   master3_cb2b887c-71b4-4fca-9fea-9bab10279502   13d</span><br><span class="line">kube-system       kube-scheduler            master2_a741b6df-5833-4dc5-bf5d-6755709cbe1e   13d</span><br></pre></td></tr></table></figure>
<p>可以看到获取到lease的kube-scheduler是跑在master2这个节点上的。kube-controller-manager  是master3这个节点上的。</p>
<p>apiserver的HA/LB与haproxy和keepalived的集成主要是一些服务配置，</p>
<ul>
<li>haproxy需要在每一个controller上面安装，目的是一个机器上的haproxy宕掉之后，可以结合keepalived让其它节点上的haproxy继续工作。</li>
<li>keepalived需要在每一个controller上面安装，keepalived的目的是提供一个VIP，或者说是一个浮动IP。</li>
<li>以kubeadm的安装为例，首个节点需要control-plane-endpoint来指定控制节点的endpoint，即VIP+haproxy bind的端口。首个节点部署成功的时候会输出join其它控制节点命令。</li>
<li>其它控制节点在加入cluster时指定的endpoint不再是某个node上的物理IP，而是VIP+haproxy bind。这样只要保证VIP是可以联通的，某个节点到宕掉不影响整个cluster的工作。</li>
<li>加入其它结点之前需要先同步密钥和证书，这部分现在是手动做的，个人觉得上游社区是不会接受将其自动化处理的，因为这步操作会修改文件系统上的文件，上游应该会觉得这部分不应该归他们管吧。这部分文件包括（ca.crt，ca.key，sa.key，sa.pub，front-proxy-ca.crt，front-proxy-ca.key，etcd/ca.crt，etcd/ca.key） </li>
</ul>
<h2 id="haproxy与keepalived配置"><a href="#haproxy与keepalived配置" class="headerlink" title="haproxy与keepalived配置"></a>haproxy与keepalived配置</h2><p>下面列出haproxy以及keepalived的配置，每个节点上的配置保持相同，并对需要注意的点加以说明，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/etc/haproxy/haproxy.cfg(see: https://github.com/chendave/initrepo/tree/master/ha)</span><br><span class="line"></span><br><span class="line">frontend kubernetes-apiserver</span><br><span class="line">    bind *:16443  [1]</span><br><span class="line">    mode tcp    [2]</span><br><span class="line">    option tcplog</span><br><span class="line">    default_backend kubernetes-apiserver</span><br><span class="line"></span><br><span class="line">backend kubernetes-apiserver</span><br><span class="line">    mode tcp</span><br><span class="line">    balance roundrobin  [3] </span><br><span class="line">    server master 10.169.180.51:6443 check [4]</span><br><span class="line">    server master1 10.169.212.212:6443 check</span><br><span class="line">    server master2 10.169.182.17:6443 check</span><br></pre></td></tr></table></figure>
<p>[1] 这里可以绑定任何不冲突的端口，后面我们用kubeadm在bootstrap其它节点时用的都是这个端口。<br>[2] 这里需要走tcp协议而不能用http <a href="https://serverfault.com/questions/611272/haproxy-http-vs-tcp" target="_blank" rel="noopener">haproxy-http-vs-tcp</a> 有做解释，apiserver走的是https协议，所以如果用http的话会出错。<br>[3] 参考<a href="https://www.haproxy.org/download/2.5/doc/configuration.txt" target="_blank" rel="noopener">configuration</a> 文档的说明，现在有多达10个算法，在我的实验里用了最普通的roundrobin。<br>[4]  后端对应的apiserver应该是物理IP加6443，无论前端bind的port是多少，6443是一定会在每个机器上存在的，这也是能balance的一个关键所在，注意VIP是独立的和服务原生的IP以及端口不是替换的关系。</p>
<blockquote>
<pre><code>roundrobin  Each server is used in turns, according to their weights.
            This is the smoothest and fairest algorithm when the server&apos;s
            processing time remains equally distributed. This algorithm
            is dynamic, which means that server weights may be adjusted
            on the fly for slow starts for instance. It is limited by
            design to 4095 active servers per backend. Note that in some
            large farms, when a server becomes up after having been down
            for a very short time, it may sometimes take a few hundreds
            requests for it to be re-integrated into the farm and start
            receiving traffic. This is normal, though very rare. It is
            indicated here in case you would have the chance to observe
            it, so that you don&apos;t worry.
</code></pre></blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># netstat -anp | grep  6443</span></span><br><span class="line">tcp        0      0 0.0.0.0:16443           0.0.0.0:*               LISTEN      13015/haproxy</span><br><span class="line">tcp        0      0 10.169.180.90:16443     10.169.212.212:48064    ESTABLISHED 13015/haproxy</span><br><span class="line">tcp6       0      0 :::6443                 :::*                    LISTEN      21206/kube-apiserve</span><br><span class="line">tcp6       0      0 10.169.180.51:6443      10.169.180.51:40086     ESTABLISHED 21206/kube-apiserve</span><br></pre></td></tr></table></figure>
<p>再来看看keepalived的配置，每个机器上的配置稍有不通，主要在于如何合理的调整权重，可以参考github上的配置（<a href="https://github.com/chendave/initrepo/tree/master/ha）。" target="_blank" rel="noopener">https://github.com/chendave/initrepo/tree/master/ha）。</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id master1   [1]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">    script &quot;/bin/bash -c &apos;if [[ $(netstat -nlp | grep 16443) ]]; then exit 0; else exit 1; fi&apos;&quot;  # haproxy 检测 [2]</span><br><span class="line">    interval 2  # 每2秒执行一次检测</span><br><span class="line">    weight 20 # 权重变化 [3]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI-kube-master &#123;</span><br><span class="line">    state MASTER  [4]</span><br><span class="line">    interface eth0   [5]</span><br><span class="line">    virtual_router_id 50</span><br><span class="line">    priority 100 [6]</span><br><span class="line">    unicast_src_ip 10.169.180.51 [6]</span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">        10.169.212.212      [7] peers</span><br><span class="line">        10.169.182.17</span><br><span class="line">    &#125;</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_haproxy</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.169.180.90/22</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>[1] 保证每个机器的<code>router_id</code>互不相同。<br>[2] 引入keepalived的目的是某一个haproxy挂了之后，能将VIP挂在其它节点上，所以这里加了一个脚本来检测haproxy是否还活着。<br>[3] weight和priority一起决定最后的VIP挂在哪个物理机上，算法可以查看keepalived的说明。<br>通过weight和priority的调整，来做到当一个机器上的haproxy服务停止之后，VIP可以在其它机器上次权重的机器上的挂起。<br>[4] 标志当前的状态，据说关系不大。<br>[5] VIP挂在哪个物理的nic之下。<br>[6] 本机的物理IP地址。<br>[7] 之所以使用unicast的原因是很多情况下multicast被禁，例如在工作场所，所以往往配置为multicast的时候，对端的节点无法获知对端是否已经绑定了VIP，结果就是网络里可能有多个VIP造成我们的实验失败。</p>
<p>在master1的节点上可以看到VIP已经被挂起，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">root@master1 <span class="comment"># ip a</span></span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">	…</span><br><span class="line">    inet 10.169.180.90/22 scope global secondary eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"><span class="comment"># systemctl status keepalived.service</span></span><br><span class="line">10月 30 18:16:23 master1 Keepalived_vrrp[32078]: VRRP_Instance(VI-kube-master) forcing a new MASTER election</span><br><span class="line">10月 30 18:16:24 master1 Keepalived_vrrp[32078]: VRRP_Instance(VI-kube-master) Transition to MASTER STATE</span><br><span class="line">10月 30 18:16:25 master1 Keepalived_vrrp[32078]: VRRP_Instance(VI-kube-master) Entering MASTER STATE</span><br><span class="line"></span><br><span class="line"><span class="comment"># ping -c 5 10.169.180.90</span></span><br><span class="line">PING 10.169.180.90 (10.169.180.90) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.169.180.90: icmp_seq=1 ttl=62 time=0.235 ms</span><br><span class="line">64 bytes from 10.169.180.90: icmp_seq=2 ttl=62 time=0.178 ms</span><br><span class="line">64 bytes from 10.169.180.90: icmp_seq=3 ttl=62 time=0.192 ms</span><br><span class="line">64 bytes from 10.169.180.90: icmp_seq=4 ttl=62 time=0.185 ms</span><br><span class="line">64 bytes from 10.169.180.90: icmp_seq=5 ttl=62 time=0.193 ms</span><br><span class="line"></span><br><span class="line">root@master3:~<span class="comment"># systemctl status keepalived.service</span></span><br><span class="line">Nov 08 08:13:17 master3 Keepalived_vrrp[6165]: Using LinkWatch kernel netlink reflector...</span><br><span class="line">Nov 08 08:13:17 master3 Keepalived_vrrp[6165]: VRRP_Instance(VI-kube-master) Entering BACKUP STATE</span><br><span class="line">Nov 08 08:13:17 master3 Keepalived_vrrp[6165]: VRRP_Script(chk_haproxy) succeeded</span><br><span class="line">Nov 08 08:13:18 master3 Keepalived_vrrp[6165]: VRRP_Instance(VI-kube-master) Changing effective priority from 80 to 100</span><br></pre></td></tr></table></figure>
<h2 id="kubeadm-bootstrap"><a href="#kubeadm-bootstrap" class="headerlink" title="kubeadm bootstrap"></a>kubeadm bootstrap</h2><p>看看我们用kubeadm来创建各个节点的命令。apiserver-cert-extra-sans的目的是让CLI可以在其它机器上也可以运行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --control-plane-endpoint=<span class="string">"10.169.180.90:16443"</span> --pod-network-cidr=10.244.0.0/16 --apiserver-cert-extra-sans=master2,10.169.180.90,master3 --upload-certs</span><br></pre></td></tr></table></figure>
<p>加入其它controller节点，至少三个，<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 10.169.180.90:16443 --token q1vi54.rqy34szr6xn56s0k \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:dac15eaa52a6c9fff179693aea175df23719e6cb09d5a9281a3104148b13ebfb \</span><br><span class="line">        --control-plane --certificate-key 1fb83358db692a50f9d0dd4c6658af8d46e2ee8f1921f37b180cce2ec3f0d51b</span><br></pre></td></tr></table></figure></p>
<p>加入至少一个worker节点，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 10.169.180.90:16443 --token q1vi54.rqy34szr6xn56s0k \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:dac15eaa52a6c9fff179693aea175df23719e6cb09d5a9281a3104148b13ebfb</span><br></pre></td></tr></table></figure>
<p>检查是否多个控制节点都已经就绪.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@master1:/etc/keepalived<span class="comment"># kubectl get node</span></span><br><span class="line">NAME                   STATUS                     ROLES                  AGE   VERSION</span><br><span class="line">master1                Ready                      control-plane,master   13d   v1.21.1</span><br><span class="line">master3                Ready                      control-plane,master   13d   v1.21.1</span><br><span class="line">master2                Ready                      control-plane,master   13d   v1.21.2</span><br><span class="line"></span><br><span class="line">root@master1:/etc/keepalived<span class="comment"># kubectl get pod -n kube-system -o wide | grep kube-apiserver</span></span><br><span class="line">kube-apiserver-master1            1/1     Running   3          10d   10.169.180.51    master1  &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-apiserver-master3            1/1     Running   0          10d   10.169.212.212   master3  &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-apiserver-master2            1/1     Running   3          12d   10.169.182.17    master2  &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h2 id="etcd-相关"><a href="#etcd-相关" class="headerlink" title="etcd 相关"></a>etcd 相关</h2><p>kubeadm在处理etcd的时候并不复杂，简单来说就是创建static  pod所需要的yaml文件，并调用etcd的CLI将其它机器上的etcd的instance加入到etcd的cluster中去，</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /go/src/k8s.io/kubernetes/cmd/kubeadm/app/cmd/phases/join/controlplanejoin.go （以stack的模式为例）</span></span><br><span class="line"><span class="keyword">if</span> err := etcdphase.CreateStackedEtcdStaticPodManifestFile(client, data.ManifestDir(), data.PatchesDir(), cfg.NodeRegistration.Name, &amp;cfg.ClusterConfiguration, &amp;cfg.LocalAPIEndpoint, data.DryRun(), data.CertificateWriteDir()); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> errors.Wrap(err, <span class="string">"error creating local etcd static pod manifest file"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// /go/src/k8s.io/kubernetes/cmd/kubeadm/app/util/etcd/etcd.go</span></span><br><span class="line">cli, err := clientv3.New(clientv3.Config&#123;</span><br><span class="line">Endpoints:   c.Endpoints,</span><br><span class="line">DialTimeout: etcdTimeout,</span><br><span class="line">DialOptions: []grpc.DialOption&#123;</span><br><span class="line">grpc.WithBlock(), <span class="comment">// block until the underlying connection is up</span></span><br><span class="line">&#125;,</span><br><span class="line">TLS: c.TLS,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>而etcd的同步是基于raft算法，一个从paxos算法衍生的分布式数据库同步算法（有机会可以去深入分析一下）。</p>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>几个基本的cases，</p>
<ol>
<li>停止某个节点上haproxy，VIP会浮动到次优节点，依然可以创建pods。</li>
<li>在apiserver里打上log，创建多个pods，请求被发送到多个不同的控制节点上。</li>
<li>停止某个节点上的scheduler服务，依然可以创建pods。</li>
</ol>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><hr>
<p><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/ha-topology/" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/ha-topology/</a><br><a href="https://blog.csdn.net/chenleiking/article/details/84841394" target="_blank" rel="noopener">https://blog.csdn.net/chenleiking/article/details/84841394</a></p>

        </div>
        <footer class="article-footer">
            



    <a data-url="http://jungler.com/2021/11/09/Kubernetes-HA-and-LB-cluster-setup/" data-id="cl4qwlbve000ebwccalqr4kdn" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "author": {
            "@type": "Person",
            "name": "Dave Chen"
        },
        "headline": "Kubernetes - HA and LB cluster setup",
        "image": "http://jungler.com/css/images/mid-autumn.jpg",
        "keywords": "Kubernetes",
        "genre": "",
        "datePublished": "2021-11-09",
        "dateCreated": "2021-11-09",
        "dateModified": "2022-06-19",
        "url": "http://jungler.com/2021/11/09/Kubernetes-HA-and-LB-cluster-setup/",
        "description": "分布式系统的HA和LB一直是一个关键性技术点，Kubernetes也有许多方面的考虑和实现来支持HA/LB，比方说lease，网络流量方面的LB（kube-proxy），以及在整体架构上与业界比较通用的haproxy与keepalived解决方案的集成，其它第三方的项目包括kube-vip, nginx-ingress等。
本文记录一下在与haproxy以及keepalived做集成的一些关键性的",
        "wordCount": 2148
    }
</script>

</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>


    
    </section>



                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="stack-overflow" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-stack-overflow"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/chendave" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank" rel="noopener">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2022/06/16/Kubernetes-metric-server简介/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            Kubernetes - metric server简介
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2021/09/21/kubemark-perf-test-clusterloader-本地性能测试的注意事项/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">kubemark + perf_test(clusterloader) 本地性能测试的注意事项</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2022/06/16/Kubernetes-metric-server简介/" class="thumbnail">
    
    
        <span style="background-image:url(/css/images/世博.jpg)" alt="Kubernetes - metric server简介" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2022/06/16/Kubernetes-metric-server简介/" class="title">Kubernetes - metric server简介</a></p>
                            <p class="item-date"><time datetime="2022-06-16T08:24:28.000Z" itemprop="datePublished">2022-06-16</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/11/09/Kubernetes-HA-and-LB-cluster-setup/" class="thumbnail">
    
    
        <span style="background-image:url(/css/images/mid-autumn.jpg)" alt="Kubernetes - HA and LB cluster setup" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2021/11/09/Kubernetes-HA-and-LB-cluster-setup/" class="title">Kubernetes - HA and LB cluster setup</a></p>
                            <p class="item-date"><time datetime="2021-11-09T03:07:45.000Z" itemprop="datePublished">2021-11-09</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/09/21/kubemark-perf-test-clusterloader-本地性能测试的注意事项/" class="thumbnail">
    
    
        <span style="background-image:url(https://github.com/chendave/chendave.github.io/raw/master/css/images/绍兴.jpg)" alt="kubemark + perf_test(clusterloader) 本地性能测试的注意事项" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2021/09/21/kubemark-perf-test-clusterloader-本地性能测试的注意事项/" class="title">kubemark + perf_test(clusterloader) 本地性能测试的注意事项</a></p>
                            <p class="item-date"><time datetime="2021-09-21T04:35:43.000Z" itemprop="datePublished">2021-09-21</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/07/25/kubelet若干配置-待更新/" class="thumbnail">
    
    
        <span style="background-image:url(https://github.com/chendave/chendave.github.io/raw/master/css/images/西湖.jpg)" alt="kubelet若干配置-待更新" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2021/07/25/kubelet若干配置-待更新/" class="title">kubelet若干配置-待更新</a></p>
                            <p class="item-date"><time datetime="2021-07-25T07:03:16.000Z" itemprop="datePublished">2021-07-25</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2021/02/16/Kubernetes-从APIServer到Kubelet/" class="thumbnail">
    
    
        <span style="background-image:url(https://github.com/chendave/chendave.github.io/raw/master/css/images/崇明.jpg)" alt="Kubernetes-从APIServer到Kubelet" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/2021/02/16/Kubernetes-从APIServer到Kubelet/" class="title">Kubernetes-从APIServer到Kubelet</a></p>
                            <p class="item-date"><time datetime="2021-02-16T12:40:54.000Z" itemprop="datePublished">2021-02-16</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">1</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ceph/">Ceph</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kubernetes/">Kubernetes</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenStack/">OpenStack</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a><span class="tag-list-count">2</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/Ceph/" style="font-size: 15px;">Ceph</a> <a href="/tags/Kubernetes/" style="font-size: 20px;">Kubernetes</a> <a href="/tags/OpenStack/" style="font-size: 20px;">OpenStack</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2022 Dave Chen</p>
                
                <p>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="https://github.com/ppoffice" target="_blank">PPOffice</a></p>
                
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

        
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'http://jungler.com/2021/11/09/Kubernetes-HA-and-LB-cluster-setup/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>





    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    

    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
